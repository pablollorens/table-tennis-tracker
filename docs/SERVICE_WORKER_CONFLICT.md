# Service Worker Conflict - Firebase Messaging + Next-PWA

## Problem

The application currently has **two service workers** registered:

1. **PWA Service Worker** (`/sw.js`) - Auto-generated by `next-pwa`
2. **Firebase Messaging Service Worker** (`/firebase-messaging-sw.js`) - Manually created for FCM

Having multiple service workers can cause conflicts, unpredictable behavior, and caching issues.

## Current Setup

### next-pwa Configuration
- File: `next.config.js`
- Generates: `public/sw.js` (auto-generated, minified)
- Includes: Workbox caching strategies for various resources
- Status: **Cannot be manually edited** (regenerated on each build)

### Firebase Messaging Service Worker
- File: `public/firebase-messaging-sw.js`
- Registration: Manually registered in `app/layout.tsx` (lines 45-57)
- Purpose: Handle FCM background messages and notifications
- Status: **Manually maintained**

## Solution Options

### Option 1: Remove Separate FCM Service Worker (Recommended)

**Benefits:**
- Single service worker reduces complexity
- No conflicts between workers
- Better maintainability

**Steps:**
1. Remove the manual service worker registration from `app/layout.tsx`:
```tsx
// DELETE this Script block (lines 45-57)
<Script id="register-sw" strategy="afterInteractive">
  {`
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/firebase-messaging-sw.js')
      .then((registration) => {
        console.log('Service Worker registered:', registration);
      })
      .catch((error) => {
        console.error('Service Worker registration failed:', error);
      });
  }
  `}
</Script>
```

2. Integrate Firebase Messaging into the next-pwa worker by creating a custom service worker source file that next-pwa will use. Create `public/sw-custom.js`:
```javascript
// Custom service worker source for next-pwa
importScripts('https://www.gstatic.com/firebasejs/12.5.0/firebase-app-compat.js');
importScripts('https://www.gstatic.com/firebasejs/12.5.0/firebase-messaging-compat.js');

// Initialize Firebase
firebase.initializeApp({
  apiKey: "AIzaSyBqYFq9_x8xI0YFmB7J6N8qH5K8b1Z7wQw",
  authDomain: "table-tennis-tracker-edd77.firebaseapp.com",
  projectId: "table-tennis-tracker-edd77",
  storageBucket: "table-tennis-tracker-edd77.firebasestorage.app",
  messagingSenderId: "815077490587",
  appId: "1:815077490587:web:ce3f8e76e0bca8f7f5f3b0",
  measurementId: "G-FDL3FMQRTM"
});

const messaging = firebase.messaging();

// Handle background messages
messaging.onBackgroundMessage((payload) => {
  console.log('[sw.js] Background message received:', payload);

  const notificationTitle = payload.notification?.title || 'Time for Table Tennis!';
  const notificationOptions = {
    body: payload.notification?.body || 'Ready for your daily match?',
    icon: '/icon-192x192.png',
    badge: '/favicon-32x32.png',
    tag: 'daily-match-reminder',
    renotify: false,
    requireInteraction: false,
    data: {
      url: payload.fcmOptions?.link || '/',
    },
  };

  self.registration.showNotification(notificationTitle, notificationOptions);
});

// Handle notification clicks
self.addEventListener('notificationclick', (event) => {
  console.log('[sw.js] Notification click received');
  event.notification.close();

  const urlToOpen = event.notification.data?.url || '/';

  event.waitUntil(
    clients.matchAll({ type: 'window', includeUncontrolled: true }).then((clientList) => {
      for (const client of clientList) {
        if (client.url === urlToOpen && 'focus' in client) {
          return client.focus();
        }
      }
      if (clients.openWindow) {
        return clients.openWindow(urlToOpen);
      }
    })
  );
});
```

3. Update `next.config.js` to use the custom worker:
```javascript
const withPWA = require('next-pwa')({
  dest: 'public',
  register: true,
  skipWaiting: true,
  disable: process.env.NODE_ENV === 'development',
  sw: 'sw-custom.js', // Add this line to use custom source
  // ... rest of config
});
```

4. Delete `public/firebase-messaging-sw.js` (no longer needed)

### Option 2: Keep Both Workers (Not Recommended)

**Drawbacks:**
- Potential conflicts
- Increased complexity
- Duplicate functionality

If you must keep both:
1. Ensure they have different scopes
2. Be aware of potential race conditions
3. Monitor for caching conflicts

## Current Status

### Fixed Issues
- **Firebase SDK Version Mismatch**: Updated `firebase-messaging-sw.js` to use Firebase SDK 12.5.0 (matching the main app)

### Remaining Issues
- **Service Worker Conflict**: Two workers still registered
  - `sw.js` is auto-generated by next-pwa and registers itself
  - `firebase-messaging-sw.js` is manually registered in layout.tsx
  - **Action Required**: Implement Option 1 above

## Technical Details

### Why sw.js Cannot Be Manually Edited
The `public/sw.js` file is regenerated on every build by next-pwa. It's a minified, optimized bundle that includes:
- Workbox runtime
- Precaching manifest
- Runtime caching strategies
- Next.js specific optimizations

Any manual edits to `sw.js` will be lost on the next build.

### Firebase Messaging Requirements
Firebase Cloud Messaging requires:
1. A service worker registered at the root scope (`/`)
2. Firebase SDK loaded via `importScripts`
3. Background message handler (`onBackgroundMessage`)
4. Notification click handler

These can be integrated into a custom worker source that next-pwa uses to generate the final `sw.js`.

## References

- [next-pwa Custom Worker](https://github.com/shadowwalker/next-pwa#custom-worker)
- [Firebase Messaging Web Setup](https://firebase.google.com/docs/cloud-messaging/js/client)
- [Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
